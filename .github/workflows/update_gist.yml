import yt_dlp

channels = []
with open("channels.txt", "r", encoding="utf-8") as f:
    for line in f:
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        parts = [x.strip() for x in line.split(",", 2)]
        if len(parts) != 3:
            continue
        handle, name, quality = parts
        if not handle.startswith("@"):
            handle = "@" + handle
        channels.append((handle, name, quality))

with open("live.m3u", "r", encoding="utf-8") as f:
    lines = f.readlines()

existing_links = {}
for i, line in enumerate(lines):
    if line.startswith("#EXTINF:"):
        display_name = line.split(",")[1].split(" [")[0].strip()
        if i + 1 < len(lines):
            existing_links[display_name] = i + 1

for handle, display_name, quality in channels:
    ydl_opts = {"quiet": True, "skip_download": True}
    url = f"https://www.youtube.com/{handle}/live"
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        try:
            info = ydl.extract_info(url, download=False)
            if info.get("is_live"):
                live_url = info.get("webpage_url")
                if display_name in existing_links:
                    lines[existing_links[display_name]] = live_url + "\n"
                else:
                    lines.append(f"#EXTINF:-1,{display_name} [{quality}]\n")
                    lines.append(live_url + "\n")
        except Exception:
            pass

with open("live.m3u", "w", encoding="utf-8") as f:
    f.writelines(lines)
