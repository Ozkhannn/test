name: Update YouTube Live Manifests

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install --upgrade yt-dlp requests

      - name: Prepare cookies (Netscape format)
        env:
          COOKIES_CONTENT: ${{ secrets.YT_COOKIES }}
        run: |
          if [ -n "$COOKIES_CONTENT" ]; then
            echo "$COOKIES_CONTENT" > cookies.txt
            echo "‚úÖ cookies.txt hazƒ±r."
          else
            echo "‚ö†Ô∏è COOKIES yok, giri≈üsiz √ßalƒ±≈üacak."
          fi

      - name: Normalize channels.txt
        run: |
          if [ -f channels.txt ]; then
            tr -d '\r' < channels.txt > channels_unix.txt
            mv channels_unix.txt channels.txt
          else
            echo "‚ö†Ô∏è channels.txt bulunamadƒ±!"
            exit 1
          fi

      - name: Generate per-channel manifests & update Gist
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          set -euo pipefail

          OUTDIR=manifests
          mkdir -p "$OUTDIR"
          rm -f "$OUTDIR"/*.m3u8 || true

          if [ ! -f channels.txt ]; then
            echo "‚ùå channels.txt bulunamadƒ±."
            exit 1
          fi

          while IFS=, read -r HANDLE GIST_FILE || [ -n "$HANDLE" ]; do
            if [[ -z "${HANDLE// /}" || "${HANDLE:0:1}" == "#" ]]; then
              continue
            fi

            HANDLE=$(echo "$HANDLE" | xargs)
            GIST_FILE=$(echo "$GIST_FILE" | xargs)
            [ -z "$GIST_FILE" ] && GIST_FILE="${HANDLE//[@\/]/}.m3u8"

            echo ""
            echo "[‚ñ∂] ƒ∞≈üleniyor: $HANDLE -> $GIST_FILE"

            if [[ "$HANDLE" =~ ^UC ]]; then
              YT_URL="https://www.youtube.com/channel/${HANDLE}/live"
            else
              if [[ "$HANDLE" != @* ]]; then HANDLE="@${HANDLE}"; fi
              YT_URL="https://www.youtube.com/${HANDLE}/live"
            fi

            if [ -f cookies.txt ]; then
              META=$(yt-dlp --cookies cookies.txt --no-warnings --skip-download "$YT_URL" --print "%(is_live)s %(id)s" 2>/dev/null || true)
            else
              META=$(yt-dlp --no-warnings --skip-download "$YT_URL" --print "%(is_live)s %(id)s" 2>/dev/null || true)
            fi

            if ! echo "$META" | grep -q "True"; then
              echo "‚ùå $HANDLE canlƒ± deƒüil veya eri≈üilemedi."
              continue
            fi

            VID_ID=$(echo "$META" | awk '{print $2}')
            echo "üé• Video ID: $VID_ID"

            if [ -f cookies.txt ]; then
              FORMATS=$(yt-dlp --cookies cookies.txt --no-warnings --skip-download -F "https://www.youtube.com/watch?v=${VID_ID}" 2>/dev/null || true)
            else
              FORMATS=$(yt-dlp --no-warnings --skip-download -F "https://www.youtube.com/watch?v=${VID_ID}" 2>/dev/null || true)
            fi

            MANIFEST_FILE="$OUTDIR/$GIST_FILE"
            printf "%s\n%s\n" "#EXTM3U" "#EXT-X-VERSION:3" > "$MANIFEST_FILE"

            while read -r LINE; do
              if echo "$LINE" | grep -qi "m3u8"; then
                FMT_ID=$(echo "$LINE" | awk '{print $1}')
                RES=$(echo "$LINE" | awk '{for(i=1;i<=NF;i++) if($i ~ /p$/) {print $i; exit}}')
                [ -z "$RES" ] && RES="auto"

                if [ -f cookies.txt ]; then
                  URL=$(yt-dlp --cookies cookies.txt --no-warnings --skip-download -f "$FMT_ID" --get-url "https://www.youtube.com/watch?v=${VID_ID}" 2>/dev/null | head -n1 || true)
                else
                  URL=$(yt-dlp --no-warnings --skip-download -f "$FMT_ID" --get-url "https://www.youtube.com/watch?v=${VID_ID}" 2>/dev/null | head -n1 || true)
                fi

                if [ -n "$URL" ]; then
                  printf '%s\n%s\n' "#EXT-X-STREAM-INF:BANDWIDTH=0,RESOLUTION=${RES},NAME=\"${RES}\"" "$URL" >> "$MANIFEST_FILE"
                  echo "  ‚úì format eklendi: ${RES}"
                fi
              fi
            done <<< "$(printf '%s\n' "$FORMATS")"

            LINECOUNT=$(wc -l < "$MANIFEST_FILE" | tr -d ' ')
            if [ "$LINECOUNT" -le 2 ]; then
              echo "‚ö†Ô∏è $HANDLE i√ßin m3u8 bulunamadƒ±."
              rm -f "$MANIFEST_FILE"
              continue
            fi

            echo "‚úÖ Manifest olu≈üturuldu: $MANIFEST_FILE"
          done < channels.txt

          if [ -z "${GIST_ID:-}" ] || [ -z "${GIST_TOKEN:-}" ]; then
            echo "‚ö†Ô∏è GIST_ID veya GIST_TOKEN yok; Gist y√ºklemesi atlandƒ±."
            exit 0
          fi

          python3 - <<PY
import os, json, glob, requests
gist_id = os.getenv('GIST_ID')
gist_token = os.getenv('GIST_TOKEN')
files = {}
for path in glob.glob('manifests/*.m3u8'):
    with open(path, encoding='utf-8') as f:
        files[os.path.basename(path)] = {'content': f.read()}
if not files:
    print("‚ö†Ô∏è Hi√ß manifest olu≈üturulmadƒ±, √ßƒ±kƒ±lƒ±yor.")
    raise SystemExit
payload = {"files": files}
r = requests.patch(
    f"https://api.github.com/gists/{gist_id}",
    headers={
        "Authorization": f"token {gist_token}",
        "Accept": "application/vnd.github+json"
    },
    data=json.dumps(payload)
)
print(f"Gist g√ºncellendi -> {r.status_code}")
PY
