name: Update YouTube Live Manifests

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade yt-dlp requests

      - name: Prepare cookies
        env:
          COOKIES_CONTENT: ${{ secrets.YT_COOKIES }}
        run: |
          if [ -n "$COOKIES_CONTENT" ]; then
            echo "$COOKIES_CONTENT" > cookies.txt
          fi

      - name: Update each channel manifest on Gist
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          import os, subprocess, json, shlex

          GIST_ID = os.getenv("GIST_ID")
          GIST_TOKEN = os.getenv("GIST_TOKEN")

          if not GIST_ID or not GIST_TOKEN:
              raise SystemExit("‚ùå GIST_ID veya GIST_TOKEN eksik")

          if not os.path.exists("channels.txt"):
              raise SystemExit("‚ùå channels.txt bulunamadƒ±")

          with open("channels.txt") as f:
              channels = [line.strip().split(",") for line in f if line.strip() and not line.startswith("#")]

          for handle, name, gist_file in channels:
              print(f"\n[‚ñ∂] {name} kontrol ediliyor...")

              # Handle normalize
              if handle.startswith("UC"):
                  yt_url = f"https://www.youtube.com/channel/{handle}/live"
              else:
                  if not handle.startswith("@"):
                      handle = "@" + handle
                  yt_url = f"https://www.youtube.com/{handle}/live"

              try:
                  meta = subprocess.check_output(
                      shlex.split(f"yt-dlp --no-warnings --skip-download --print '%(is_live)s %(id)s' {yt_url}"),
                      text=True
                  ).strip()

                  if "True" not in meta:
                      print(f"‚ùå {name}: canlƒ± yayƒ±n yok.")
                      continue

                  vid_id = meta.split()[1]
                  print(f"üé• Yayƒ±n ID: {vid_id}")

                  # Format listesini al
                  formats = subprocess.check_output(
                      shlex.split(f"yt-dlp --no-warnings --skip-download -F https://www.youtube.com/watch?v={vid_id}"),
                      text=True
                  )

                  manifest = ["#EXTM3U", "#EXT-X-VERSION:3"]

                  for line in formats.splitlines():
                      if "m3u8" in line:
                          parts = line.split()
                          fmt_id = parts[0]
                          res = next((p for p in parts if "p" in p), "auto")

                          url = subprocess.check_output(
                              shlex.split(f"yt-dlp --no-warnings --skip-download -f {fmt_id} --get-url https://www.youtube.com/watch?v={vid_id}"),
                              text=True
                          ).strip()

                          manifest.append(f'#EXT-X-STREAM-INF:BANDWIDTH=0,RESOLUTION={res},NAME="{res}"')
                          manifest.append(url)

                  if len(manifest) <= 2:
                      print(f"‚ö†Ô∏è {name}: format bulunamadƒ±.")
                      continue

                  manifest_str = "\n".join(manifest)

                  payload = json.dumps({
                      "files": {
                          gist_file: { "content": manifest_str }
                      }
                  })

                  subprocess.run([
                      "curl", "-s", "-X", "PATCH",
                      "-H", f"Authorization: token {GIST_TOKEN}",
                      "-H", "Content-Type: application/json",
                      "-d", payload,
                      f"https://api.github.com/gists/{GIST_ID}"
                  ], check=True)

                  print(f"‚úÖ {name} ({gist_file}) g√ºncellendi.")

              except subprocess.CalledProcessError as e:
                  print(f"‚ùå {name}: hata olu≈ütu -> {e}")
        shell: python
