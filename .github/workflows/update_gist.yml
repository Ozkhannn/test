name: Update YouTube Live Multi-Quality Gist

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install --upgrade yt-dlp requests

      - name: Prepare cookies (Netscape format)
        env:
          COOKIES_CONTENT: ${{ secrets.YT_COOKIES }}
        run: |
          if [ -n "$COOKIES_CONTENT" ]; then
            echo "$COOKIES_CONTENT" > cookies.txt
          fi

      - name: Normalize channels.txt
        run: |
          if [ -f channels.txt ]; then
            tr -d '\r' < channels.txt > channels_unix.txt
            mv channels_unix.txt channels.txt
          else
            echo "‚ö†Ô∏è channels.txt bulunamadƒ±!"
            exit 1
          fi

      - name: Process Channels and Update Gist Files
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          set -e
          echo "üöÄ Multi-quality manifest olu≈üturuluyor..."

          python3 <<'PYCODE'
import os, subprocess, json, requests

gist_id = os.environ.get("GIST_ID")
gist_token = os.environ.get("GIST_TOKEN")
cookies_file = "cookies.txt" if os.path.exists("cookies.txt") else None

if not gist_id or not gist_token:
    print("‚ùå GIST_ID veya GIST_TOKEN eksik.")
    exit(1)

headers = {
    "Authorization": f"token {gist_token}",
    "Accept": "application/vnd.github.v3+json"
}

def get_yt_meta(channel):
    """Canlƒ± yayƒ±n a√ßƒ±k mƒ±, video ID'si nedir √∂ƒüren."""
    url = f"https://www.youtube.com/{channel}/live"
    base_cmd = ["yt-dlp", "--no-warnings", "--skip-download", "--print", "%(is_live)s %(id)s", url]
    if cookies_file:
        base_cmd[1:1] = ["--cookies", cookies_file]
    try:
        meta = subprocess.check_output(base_cmd, text=True, stderr=subprocess.DEVNULL).strip()
        is_live, vid_id = meta.split()
        return is_live == "True", vid_id
    except Exception:
        return False, None

def get_quality_urls(video_id):
    """Mevcut t√ºm kalite linklerini al."""
    base_url = f"https://www.youtube.com/watch?v={video_id}"
    formats = ["144", "240", "360", "480", "720", "1080"]
    urls = {}
    for q in formats:
        fmt = f"bestvideo[height<={q}]+bestaudio/best[height<={q}]/best"
        cmd = ["yt-dlp", "--no-warnings", "--skip-download", "-f", fmt, "--get-url", base_url]
        if cookies_file:
            cmd[1:1] = ["--cookies", cookies_file]
        try:
            url = subprocess.check_output(cmd, text=True, stderr=subprocess.DEVNULL).splitlines()[0]
            urls[q] = url
        except Exception:
            continue
    return urls

def make_manifest(urls):
    """M3U8 manifest olu≈ütur."""
    lines = ["#EXTM3U", "#EXT-X-VERSION:3"]
    for q, url in urls.items():
        bw = {
            "144": "150000",
            "240": "400000",
            "360": "800000",
            "480": "1200000",
            "720": "2500000",
            "1080": "4500000"
        }.get(q, "800000")
        res = {
            "144": "256x144",
            "240": "426x240",
            "360": "640x360",
            "480": "854x480",
            "720": "1280x720",
            "1080": "1920x1080"
        }.get(q, "640x360")
        lines.append(f"#EXT-X-STREAM-INF:BANDWIDTH={bw},RESOLUTION={res}")
        lines.append(url)
    return "\n".join(lines)

# T√ºm gist i√ßeriƒüini √ßek
gist_url = f"https://api.github.com/gists/{gist_id}"
gist_data = requests.get(gist_url, headers=headers).json()
files = gist_data.get("files", {})

with open("channels.txt") as f:
    for line in f:
        if not line.strip() or line.startswith("#"):
            continue
        channel, filename = [x.strip() for x in line.split(",")]
        print(f"[‚ñ∂] {channel} i≈üleniyor...")

        is_live, vid = get_yt_meta(channel)
        if not is_live or not vid:
            print(f"‚ùå {channel}: canlƒ± deƒüil veya ID bulunamadƒ±.")
            continue

        urls = get_quality_urls(vid)
        if not urls:
            print(f"‚ö†Ô∏è {channel}: linkler alƒ±namadƒ±.")
            continue

        manifest = make_manifest(urls)
        files[filename] = {"content": manifest}
        print(f"‚úÖ {channel} -> {filename} ({len(urls)} kalite)")

payload = {"files": files}
r = requests.patch(gist_url, headers=headers, data=json.dumps(payload))
print(f"üì§ Gist g√ºncellendi -> HTTP {r.status_code}")
PYCODE

      - name: Cleanup
        run: rm -f cookies.txt || true
